#!/bin/bash

#
# XXX
#  - check that we're running as root
#  - top directory (/usr/local/crosware)
#    - software install dir (/usr/local/crosware/software/packagename-vX.Y.Z)
#    - download dir (/usr/local/crosware/download or ~/Downloads)
#    - build dir (/usr/local/crosware/build)
#    - current/previous symlinks for versioned installs
#    - ignore directories with generated files (path, cpp/ld flags, ...)
#    - ignore software install dir
#    - ignore 
#  - what will a "reboostrap" do?
#  - canonical arch
#    - use static "toybox file" to figure out?
#  - java arch
#  - all(?) aarch64 chrome os machines are using 32-bit armv7l userland (for arm chrome pepper/flash?)
#    - jdk will need to be arm on aarch64
#  - handle armv8l 32-bit compat on aarch64
#  - handle i386 (?)
#    - no current, supported chrome os devices are 32-bit
#    - maybe grab neverware cloudready 32b for testing?
#  - files to source w/path, compiler vars, pkg-config, etc.
#    - top-level etc/profile to source
#    - sources an etc/local and/or etc/local.d with shell snippets (obvious, local settings)
#    - reads in generated shell snippets (one per package) to set:
#      - PATH (etc/paths.d)
#      - CC, CXX, CFLAGS, CXXFLAGS, CPPFLAGS, LDFLAGS (etc/cppflags.d, etc/ldflags.d, ...)
#      - PKG_CONFIG_PATH, PKG_CONFIG_LIBDIR (etc/pkg-config.d)
#  - dependencies and dependants (maybe?)
#    - simple directory of files with pkgname.dependents, pkgname.dependencies
#  - install must chase down upstream deps
#  - update may require downstream dep updates
#  - etc/local.d - scriptlets, not tracked in git
#  - var/ - track installs/versions
#  - use_local_java - env var to avoid dl/use of zulu during bootstrap
#

#
# shell feature and usage check
#

# make sure we're using bash and not sourced
if [ -z "${BASH_SOURCE}" -o "${0}" != "${BASH_SOURCE}" ] ; then
  echo "please execute this script instead of sourcing it"
  if [ "${0}" != "${BASH_SOURCE}" ] ; then
    return
  fi
  exit 1
fi

# check that we're using bash 4
if [ ${BASH_VERSINFO[0]} -lt 4 ] ; then
  echo "please make sure GNU Bash 4+ is in use"
  exit 1
fi

# exit early, exit often
set -eu

#
# prereqs
#
# XXX - curl, ... wget? what else?
prereqs=( curl )
for prereq in ${prereqs[@]} ; do
  which "${prereq}" >/dev/null 2>&1 || {
    echo "${prereq} not found"
    exit 1
  }
done

#
# where we live
#
# XXX - default to /usr/local/crosware but allow override (that may or may not work)
: ${cwtop:="/usr/local/crosware"}
export cwtop
export cwbuild="${cwtop}/builds"
export cwddl="${cwtop}/downloads"
export cwetc="${cwtop}/etc"
export cwsw="${cwtop}/software"
export cwtmp="${cwtop}/tmp"

# we'll use this for bootstrap since /tmp may be mounted noexec
: ${tmptmp:="/usr/local/tmp"}
export tmptmp

# temp dir permissions
export tmpperm="1777"

#
# supported architecture check
#

# architecture names and support
supported_arches=( aarch64 armv6l armv7l armv8l x86_64 )
export karch="$(uname -m)"

# be somewhat strict about supported architectures
supported=0
for supported_arch in ${supported_arches[@]} ; do
  if [[ ${karch} =~ ^${supported_arch}$ ]] ; then
    supported=1
  fi
done
if [ ${supported} -eq 0 ] ; then
  echo "architecture ${karch} not supported"
  exit 1
fi

#
# userspace vs kernel architecture check
#

# userspace may be different than kernel, i.e., 32-bit arm on 64-bit aarch64
# we'll use the first chunk of bash $MACHTYPE environment variable
# it will be something like:
#   x86_64-cros-linux-gnu (x86_64 chrome os)
#   armv7a-cros-linux-gnu (armv7l and aarch64 chrome os with 32-bit userspace)
#   arm-unknown-linux-gnueabihf (armv7l (armv6l?) 32-bit debian/ubuntu/raspbian)
#   arm-unknown-linux-gnueabi (armv7l 32-bit debian?)
#   aarch64-unknown-linux-gnu (aarch64 full 64-bit debian/ubuntu)
#   aarch64-alpine-linux-musl (aarch64 full 64-bit alpine)
#   armv6-alpine-linux-musleabihf (armv6/armv7 32-bit alpine)
#   x86_64-generic-linux-gnu (intel clear linux)
#   x86_64-pc-linux-gnu (x86_64 debian/ubuntu)
#   x86_64-redhat-linux-gnu (x86_64 centos/rhel/fedora)
#   ...
# transform arm or armv7a to armv7l for parity with "uname -m"
# XXX - this assumes aarch64/x86_64 return the "right" $MACHTYPE
# XXX - this assumes we have hardware float on armv6/v7
export bash_triplet="${MACHTYPE}"
bash_arch="${MACHTYPE%%-*}"
if [[ ${bash_arch} =~ ^arm ]] ; then
  if [[ ${karch} =~ ^aarch64 ]] ; then
    bash_arch="armv7l"
  elif [[ ${karch} =~ ^armv(6|7|8) ]] ; then
    bash_arch="${bash_arch/#arm*/$(uname -m)}"
  fi
fi
export uarch="${bash_arch}"

#
# zulu jdk setup (for bootstrap)
#

# XXX - zulu jdk arch will be uarch

# basic zulu vars
zulu_inst_dir="zulu"

# zulu jdk arch map
# XXX - arm 32-bit hard float assumption, again
declare -A zulu_jdk_arch
zulu_jdk_arch["aarch64"]="aarch64"
zulu_jdk_arch["armv6l"]="aarch32hf"
zulu_jdk_arch["armv7l"]="aarch32hf"
zulu_jdk_arch["armv8l"]="aarch32hf"
zulu_jdk_arch["x86_64"]="x64"

# zulu jdk version map
declare -A zulu_jdk_ver
zulu_jdk_ver["aarch64"]="1.8.0_152-8.25.0.79"
zulu_jdk_ver["armv6l"]="1.8.0_152-8.25.0.76"
zulu_jdk_ver["armv7l"]="1.8.0_152-8.25.0.76"
zulu_jdk_ver["armv8l"]="1.8.0_152-8.25.0.76"
zulu_jdk_ver["x86_64"]="8.25.0.1-jdk8.0.152"

# zulu jdk file sha256sum
declare -A zulu_jdk_sha256sum
zulu_jdk_sha256sum["aarch64"]="45997b734a0d3ec5035b836f8c235d291c677547811704e3c62f656ee943cdc8"
zulu_jdk_sha256sum["armv6l"]="a7bc9f9edd1cf60aad51b9c6b93c8dcf49af87891b8de5d7982d0d97bfb43636"
zulu_jdk_sha256sum["armv7l"]="a7bc9f9edd1cf60aad51b9c6b93c8dcf49af87891b8de5d7982d0d97bfb43636"
zulu_jdk_sha256sum["armv8l"]="a7bc9f9edd1cf60aad51b9c6b93c8dcf49af87891b8de5d7982d0d97bfb43636"
zulu_jdk_sha256sum["x86_64"]="57911a136fedc476a8b505d00c364913bf4cf5b7a50ef6913334362bc219e21a"

# zulu directory, file, and url map
declare -A zulu_jdk_dir zulu_jdk_file zulu_jdk_url
for supported_arch in ${supported_arches[@]} ; do
  if [[ ${supported_arch} =~ ^x86_64$ ]] ; then
    zulu_jdk_dir[${supported_arch}]="zulu${zulu_jdk_ver[${supported_arch}]}-linux_${zulu_jdk_arch[${supported_arch}]}"
    zulu_jdk_base_url="http://cdn.azul.com/zulu/bin"
  elif [[ ${supported_arch} =~ ^a(rmv|arch) ]] ; then
    zulu_jdk_dir[${supported_arch}]="ezdk-${zulu_jdk_ver[${supported_arch}]}-eval-linux_${zulu_jdk_arch[${supported_arch}]}"
    zulu_jdk_base_url="http://cdn.azul.com/zulu-embedded/bin"
  fi
  zulu_jdk_file[${supported_arch}]="${zulu_jdk_dir[${supported_arch}]}.tar.gz"
  zulu_jdk_url[${supported_arch}]="${zulu_jdk_base_url}/${zulu_jdk_file[${supported_arch}]}"
done

#
# jgit
#

# XXX - will need to make sure java tmpdir is set
# https://repo.eclipse.org/content/groups/releases/org/eclipse/jgit/org.eclipse.jgit.pgm/4.9.1.201712030800-r/org.eclipse.jgit.pgm-4.9.1.201712030800-r.sh
jgitsh_ver="4.9.1.201712030800-r"
jgitsh_file="org.eclipse.jgit.pgm-${jgitsh_ver}.sh"
jgitsh_url="https://repo.eclipse.org/content/groups/releases/org/eclipse/jgit/org.eclipse.jgit.pgm/${jgitsh_ver}/${jgitsh_file}"
jgitsh_sha256sum="0b2b613cf1cdc5066c812edf83250c32e7dbb37cb169d9802d398d5b8aef6452"
jgitsh_symlink="jgit.sh"
jgitsh_inst_dir="jgit"

#
# static compiler bootstrap
#

# XXX - compiler arch will be karch/uname -m

# common static compiler release/tag, archive, and url
static_toolchain_archive_ext="tar.bz2"
static_toolchain_checksum_ext="sha256"
static_toolchain_release="20171207"
static_toolchain_base_url="https://github.com/ryanwoodsmall/musl-misc/releases/download"
static_toolchain_release_url="${static_toolchain_base_url}/${static_toolchain_release}"
static_toolchain_inst_dir="${cwsw}/static-toolchain"

# architecture to musl triplet
declare -A static_toolchain_triplet
static_toolchain_triplet["aarch64"]="aarch64-linux-musl"
static_toolchain_triplet["armv6l"]="arm-linux-musleabihf"
static_toolchain_triplet["armv7l"]="arm-linux-musleabihf"
static_toolchain_triplet["armv8l"]="arm-linux-musleabihf"
static_toolchain_triplet["x86_64"]="x86_64-linux-musl"

# architecture to release prefix
declare -A static_toolchain_prefix
static_toolchain_prefix["aarch64"]="20171207083535"
static_toolchain_prefix["armv6l"]="20171207083535"
static_toolchain_prefix["armv7l"]="20171207083535"
static_toolchain_prefix["armv8l"]="20171207083535"
static_toolchain_prefix["x86_64"]="20171207083535"

# architecture to filename, urls, sha256 file, dir, ...
declare -A static_toolchain_file static_toolchain_checksum static_toolchain_file_url static_toolchain_checksum_url static_toolchain_dir
for supported_arch in ${supported_arches[@]} ; do
  static_toolchain_file[${supported_arch}]="${static_toolchain_prefix[${supported_arch}]}-${static_toolchain_triplet[${supported_arch}]}.${static_toolchain_archive_ext}"
  static_toolchain_checksum[${supported_arch}]="${static_toolchain_file[${supported_arch}]}.${static_toolchain_checksum_ext}"
  static_toolchain_file_url[${supported_arch}]="${static_toolchain_release_url}/${static_toolchain_file[${supported_arch}]}"
  static_toolchain_checksum_url[${supported_arch}]="${static_toolchain_release_url}/${static_toolchain_checksum[${supported_arch}]}"
  static_toolchain_dir[${supported_arch}]="${static_toolchain_prefix[${supported_arch}]}-${static_toolchain_triplet[${supported_arch}]}"
done

echo "nothing to see here yet"
